<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinetra — Trajectory Optimization Visualization</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>

<header>
    <div class="header-left">
        <h1>Kinetra</h1>
        <span class="badge">C++20</span>
        <span class="badge">WebAssembly</span>
        <span class="badge">Trajectory Optimization</span>
    </div>
    <div class="header-right">
        <span class="wasm-status loading" id="wasm-status">Loading WASM...</span>
        <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode">&#9790;</button>
    </div>
</header>

<nav id="nav">
    <button class="active" data-tab="demo">Trajectory Planner</button>
    <button data-tab="trajectory">Trajectory Viewer</button>
    <button data-tab="benchmarks">Benchmarks</button>
</nav>

<main>
    <!-- Interactive Trajectory Planning Demo -->
    <div id="demo" class="tab active">
        <div class="demo-layout">
            <div class="demo-sidebar">
                <div class="card">
                    <h2>Planning Pipeline</h2>
                    <div class="pipeline-indicator">
                        <span class="pipeline-step" id="pipe-rrt">RRT*</span>
                        <span class="pipeline-arrow">&#8594;</span>
                        <span class="pipeline-step" id="pipe-opt">Optimize</span>
                        <span class="pipeline-arrow">&#8594;</span>
                        <span class="pipeline-step" id="pipe-done">Done</span>
                    </div>

                    <div class="control-group">
                        <label>Interaction Mode</label>
                        <div class="btn-group" id="mode-group">
                            <button class="btn active" data-mode="start">Start</button>
                            <button class="btn" data-mode="goal">Goal</button>
                            <button class="btn" data-mode="obstacle">Obstacle</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Start State</label>
                        <div class="state-inputs">
                            <div><input type="number" id="start-x" value="-7" step="0.5"><div class="sub-label">x</div></div>
                            <div><input type="number" id="start-y" value="0" step="0.5"><div class="sub-label">y</div></div>
                            <div><input type="number" id="start-theta" value="0" step="0.1"><div class="sub-label">&theta;</div></div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Goal State</label>
                        <div class="state-inputs">
                            <div><input type="number" id="goal-x" value="7" step="0.5"><div class="sub-label">x</div></div>
                            <div><input type="number" id="goal-y" value="0" step="0.5"><div class="sub-label">y</div></div>
                            <div><input type="number" id="goal-theta" value="0" step="0.1"><div class="sub-label">&theta;</div></div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Robot Model</label>
                        <select id="model-select">
                            <option value="DiffDriveSimple">Differential Drive (v, &omega;)</option>
                            <option value="DiffDriveAccel">Differential Drive (a, &alpha;)</option>
                            <option value="AckermannSimple">Ackermann Steering</option>
                            <option value="OmniSimple">Omnidirectional</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Trajectory Optimizer</label>
                        <select id="optimizer-select">
                            <option value="iLQR">iLQR (Iterative LQR)</option>
                            <option value="STOMP">STOMP (Stochastic)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Obstacle Radius <span class="range-value" id="radius-val">0.8</span></label>
                        <input type="range" id="obs-radius" min="0.2" max="3.0" step="0.1" value="0.8">
                    </div>

                    <div class="control-group">
                        <label>RRT* Iterations <span class="range-value" id="rrt-iter-val">3000</span></label>
                        <input type="range" id="rrt-iters" min="500" max="10000" step="500" value="3000">
                    </div>

                    <div class="control-group">
                        <label>iLQR Horizon <span class="range-value" id="horizon-val">50</span></label>
                        <input type="range" id="ilqr-horizon" min="20" max="200" step="10" value="50">
                    </div>

                    <div class="control-group" style="margin-top:1rem">
                        <button class="btn btn-primary" id="btn-plan" style="width:100%" disabled>&#9654; Plan &amp; Optimize</button>
                    </div>
                    <div class="control-group">
                        <button class="btn" id="btn-rrt-only" style="width:100%" disabled>Path Only (RRT*)</button>
                    </div>
                    <div class="control-group">
                        <button class="btn" id="btn-opt-only" style="width:100%" disabled>Optimize Only (iLQR/STOMP)</button>
                    </div>
                    <div class="control-group">
                        <button class="btn btn-danger" id="btn-clear" style="width:100%">&#10005; Clear All</button>
                    </div>
                </div>

                <div class="card">
                    <h2>Presets</h2>
                    <div class="control-group">
                        <button class="btn" id="btn-preset-1" style="width:100%">Narrow Passage</button>
                    </div>
                    <div class="control-group">
                        <button class="btn" id="btn-preset-2" style="width:100%">U-Turn</button>
                    </div>
                    <div class="control-group">
                        <button class="btn" id="btn-preset-3" style="width:100%">Cluttered Field</button>
                    </div>
                    <div class="control-group">
                        <button class="btn" id="btn-preset-4" style="width:100%">Parallel Parking</button>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>Trajectory Planning Canvas</h2>
                    <canvas id="demo-canvas" width="900" height="600"></canvas>
                    <div class="legend-row">
                        <span class="legend-start">Start</span>
                        <span class="legend-goal">Goal</span>
                        <span class="legend-obstacle">Obstacle</span>
                        <span class="legend-initial">Initial Path (RRT*)</span>
                        <span class="legend-optimized">Optimized Trajectory</span>
                        <span class="legend-heading">Heading Arrows</span>
                    </div>
                    <div class="demo-status" id="demo-status">Click canvas to place Start, Goal, Obstacles. Then click Plan &amp; Optimize. C++ algorithms run in real-time via WebAssembly.</div>
                </div>

                <div class="card">
                    <h2>Results</h2>
                    <div class="grid-2">
                        <div>
                            <h3 style="font-size:.85rem;color:var(--text-muted);margin-bottom:.5rem">RRT* Path</h3>
                            <div class="demo-stats-bar">
                                <div class="stat-item"><div class="stat-value" id="rrt-stat-nodes">-</div><div class="stat-label">Tree Nodes</div></div>
                                <div class="stat-item"><div class="stat-value" id="rrt-stat-length">-</div><div class="stat-label">Path Length</div></div>
                                <div class="stat-item"><div class="stat-value" id="rrt-stat-time">-</div><div class="stat-label">Time (ms)</div></div>
                            </div>
                        </div>
                        <div>
                            <h3 style="font-size:.85rem;color:var(--text-muted);margin-bottom:.5rem">Optimized Trajectory</h3>
                            <div class="demo-stats-bar">
                                <div class="stat-item"><div class="stat-value" id="opt-stat-cost">-</div><div class="stat-label">Cost</div></div>
                                <div class="stat-item"><div class="stat-value" id="opt-stat-smooth">-</div><div class="stat-label">Smoothness</div></div>
                                <div class="stat-item"><div class="stat-value" id="opt-stat-time">-</div><div class="stat-label">Time (ms)</div></div>
                                <div class="stat-item"><div class="stat-value" id="opt-stat-curv">-</div><div class="stat-label">Max Curvature</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Velocity Profile</h2>
                    <div id="plot-demo-velocity" style="height:250px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trajectory Viewer -->
    <div id="trajectory" class="tab">
        <div class="card">
            <h2>Load Planning Result</h2>
            <div class="upload-area" id="upload-trajectory">
                <p>Drop a Kinetra JSON result file here, or click to browse</p>
                <input type="file" id="file-input-traj" accept=".json">
            </div>
        </div>
        <div class="grid-2">
            <div class="card"><h2>Path Plot</h2><div id="plot-path" style="height:500px;"></div></div>
            <div class="card"><h2>Velocity Profile</h2><div id="plot-velocity" style="height:500px;"></div></div>
        </div>
        <div class="card">
            <h2>Path Statistics</h2>
            <div class="stats" id="path-stats">
                <div class="stat-item"><div class="stat-value" id="stat-length">-</div><div class="stat-label">Path Length</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-time">-</div><div class="stat-label">Solve Time (ms)</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-smoothness">-</div><div class="stat-label">Smoothness</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-curvature">-</div><div class="stat-label">Max Curvature</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-waypoints">-</div><div class="stat-label">Waypoints</div></div>
            </div>
        </div>
    </div>

    <!-- Benchmarks -->
    <div id="benchmarks" class="tab">
        <div class="card">
            <h2>Load Benchmark Results</h2>
            <div class="upload-area" id="upload-bench">
                <p>Drop a Google Benchmark JSON output file here</p>
                <input type="file" id="file-input-bench" accept=".json">
            </div>
        </div>
        <div class="card"><h2>Performance</h2><div id="plot-bench-time" style="height:400px;"></div></div>
        <div class="card">
            <h2>Benchmark Table</h2>
            <table id="bench-table">
                <thead><tr><th>Name</th><th>Time (ns)</th><th>CPU (ns)</th><th>Iterations</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</main>

<footer>Kinetra — World-class trajectory optimization for robotics. C++ algorithms compiled to WebAssembly.<br>Built with C++20 &middot; Eigen &middot; Emscripten &middot; Plotly.js</footer>

<script src="kinetra_wasm.js"></script>
<script src="js/interactive_demo.js"></script>
<script src="js/trajectory_viewer.js"></script>
<script src="js/benchmark_dashboard.js"></script>
<script>
// Tab navigation
document.querySelectorAll('nav button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
    });
});

// Theme toggle
const themeBtn = document.getElementById('theme-toggle');
function setTheme(t) {
    document.documentElement.setAttribute('data-theme', t);
    themeBtn.textContent = t === 'light' ? '\u2600' : '\u263E';
    localStorage.setItem('kinetra-theme', t);
    if (window.updatePlotlyTheme) window.updatePlotlyTheme();
}
themeBtn.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    setTheme(cur === 'dark' ? 'light' : 'dark');
});
const saved = localStorage.getItem('kinetra-theme');
if (saved) setTheme(saved);

// File upload helpers
function setupUpload(areaId, inputId, callback) {
    const area = document.getElementById(areaId);
    const input = document.getElementById(inputId);
    area.addEventListener('click', () => input.click());
    area.addEventListener('dragover', e => { e.preventDefault(); area.style.borderColor = 'var(--accent)'; });
    area.addEventListener('dragleave', () => { area.style.borderColor = ''; });
    area.addEventListener('drop', e => {
        e.preventDefault(); area.style.borderColor = '';
        if (e.dataTransfer.files[0]) readUploadedFile(e.dataTransfer.files[0], callback);
    });
    input.addEventListener('change', () => { if (input.files[0]) readUploadedFile(input.files[0], callback); });
}
function readUploadedFile(file, cb) {
    const r = new FileReader();
    r.onload = e => { try { cb(JSON.parse(e.target.result)); } catch(err) { alert('Invalid JSON: ' + err.message); } };
    r.readAsText(file);
}
setupUpload('upload-trajectory', 'file-input-traj', loadTrajectory);
setupUpload('upload-bench', 'file-input-bench', loadBenchmarks);
</script>

</body>
</html>
