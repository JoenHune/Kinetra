name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────── Native Build & Test ───────────────────────────
  build-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-14]
        build_type: [Debug, Release]
        include:
          - os: ubuntu-24.04
            compiler: g++-13
          - os: macos-14
            compiler: clang++

    runs-on: ${{ matrix.os }}
    name: "${{ matrix.os }} / ${{ matrix.build_type }}"

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++-13

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.compiler }} \
            -DKINETRA_BUILD_TESTS=ON \
            -DKINETRA_BUILD_BENCHMARKS=ON \
            -DKINETRA_BUILD_EXAMPLES=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure --timeout 120

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.build_type }}
          path: build/Testing/

  # ───────────────────────── Sanitizer Builds ────────────────────────────────
  sanitizers:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        sanitizer: [asan, tsan]
    name: "Sanitizer / ${{ matrix.sanitizer }}"

    steps:
      - uses: actions/checkout@v4

      - name: Install
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build g++-13

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DKINETRA_BUILD_TESTS=ON \
            -DKINETRA_ENABLE_ASAN=${{ matrix.sanitizer == 'asan' && 'ON' || 'OFF' }} \
            -DKINETRA_ENABLE_TSAN=${{ matrix.sanitizer == 'tsan' && 'ON' || 'OFF' }}

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure --timeout 180

  # ──────────────────────── ARMv7 Cross-Compilation ──────────────────────────
  cross-armv7:
    runs-on: ubuntu-24.04
    name: "Cross / ARMv7"

    steps:
      - uses: actions/checkout@v4

      - name: Install cross toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            qemu-user-static

      - name: Configure (cross)
        run: |
          cmake -B build-arm -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/armv7-linux-gnueabihf.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DKINETRA_USE_FLOAT=ON \
            -DKINETRA_BUILD_TESTS=ON \
            -DKINETRA_BUILD_EXAMPLES=ON \
            -DCMAKE_CROSSCOMPILING_EMULATOR="qemu-arm-static;-L;/usr/arm-linux-gnueabihf"

      - name: Build (cross)
        run: cmake --build build-arm --parallel

      - name: Test via QEMU
        run: |
          cd build-arm
          ctest --output-on-failure --timeout 120 || true

      - name: Report binary sizes
        run: |
          echo "### ARMv7 Binary Sizes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          arm-linux-gnueabihf-size build-arm/libkinetra.a >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ──────────────────────── WebAssembly Build ─────────────────────────────────
  wasm:
    runs-on: ubuntu-24.04
    name: "WebAssembly (Emscripten)"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      - name: Configure Wasm build
        run: emcmake cmake -B build-wasm -S wasm -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build-wasm --parallel

      - name: Verify output
        run: |
          echo "### WebAssembly Build" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh build-wasm/kinetra_wasm.js build-wasm/kinetra_wasm.wasm >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ──────────────────────── Benchmarks (Release) ─────────────────────────────
  benchmarks:
    runs-on: ubuntu-24.04
    name: "Benchmarks"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Install
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build g++-13

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DKINETRA_BUILD_BENCHMARKS=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Run benchmarks
        run: |
          mkdir -p benchmark_results
          for bench_bin in build/benchmarks/kinetra_bench_*; do
            if [ -f "$bench_bin" ]; then
              name=$(basename "$bench_bin")
              "$bench_bin" \
                --benchmark_format=json \
                --benchmark_out="benchmark_results/${name}.json" \
                --benchmark_repetitions=5
            fi
          done

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results/

  # ──────────────────────── Deploy GitHub Pages ──────────────────────────────
  pages:
    runs-on: ubuntu-24.04
    needs: [build-test, wasm]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
